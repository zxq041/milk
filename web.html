<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MilkShake System 1.1</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <style>
    :root {
      --primary-color: #00a79d;
      --secondary-color: #ff6b6b;
      --danger-color: #e74c3c;
      --background-light: #fff8e7;
      --background-dark: #003b46;
      --text-color-dark: #07575b;
      --text-color-light: #f5f5f5;
      --gradient-bg: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      --border-radius: 20px;
    }
    *,
    ::after,
    ::before {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html { scroll-behavior: smooth; }
    body {
      font-family: 'Poppins', sans-serif;
      color: var(--text-color-dark);
      background-color: var(--background-light);
      overflow-x: hidden;
    }

    .admin-wrapper { display: flex; min-height: 100vh; position: relative; }
    .sidebar {
      width: 280px; flex-shrink: 0; background-color: var(--background-dark);
      color: var(--text-color-light); display: flex; flex-direction: column; padding: 20px;
      transition: transform .3s ease-in-out;
    }
    .sidebar-header { display:flex; align-items:center; gap:15px; padding:10px; margin-bottom:30px; }
    .sidebar-header img { width:50px; height:50px; border-radius:12px; }
    .sidebar-header .title-block { line-height:1.2; }
    .sidebar-header .title { font-weight:700; font-size:1.2rem; color:#fff; }
    .sidebar-header .subtitle { font-size:.8rem; opacity:.7; }
    .sidebar-nav { list-style:none; flex-grow:1; }
    .nav-link { display:flex; align-items:center; gap:15px; padding:18px 20px; margin-bottom:10px; border-radius:12px; text-decoration:none; color:var(--text-color-light); font-weight:600; transition:all .3s ease; }
    .nav-link:hover { background-color: rgba(255,255,255,.1); }
    .nav-link.active{ background: var(--gradient-bg); color:#fff; box-shadow:0 4px 20px rgba(0,167,157,.4); transform: scale(1.02); }
    .nav-link i { width:20px; text-align:center; }

    .main-content { flex-grow:1; padding:40px; overflow-y:auto; display:flex; flex-direction:column; }
    .main-header { display:none; align-items:center; gap:20px; margin-bottom:20px; }
    .menu-toggle-btn { background:#fff; border:none; width:50px; height:50px; border-radius:50%; box-shadow:var(--shadow); color:var(--primary-color); font-size:1.2rem; cursor:pointer; }

    .section-title { font-size: clamp(2rem, 4vw, 2.5rem); font-weight:900; margin-bottom:30px; background:var(--gradient-bg); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .section-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; gap:15px; flex-wrap:wrap; }

    .card { background:#fff; padding:30px; border-radius:var(--border-radius); box-shadow:var(--shadow); margin-bottom:25px; }
    .btn { padding:12px 20px; border-radius:50px; font-weight:600; text-decoration:none; cursor:pointer; transition:all .3s ease; border:none; display:inline-flex; align-items:center; justify-content:center; gap:10px; }
    .btn-primary { background: var(--gradient-bg); color:#fff; box-shadow:0 4px 20px rgba(0,167,157,.4); }
    .btn-primary:hover{ transform: translateY(-2px); box-shadow:0 8px 25px rgba(0,167,157,.6); }
    .btn-secondary { background:#eee; color:var(--text-color-dark); }
    .btn-secondary:hover{ background:#ddd; }
    .btn-danger{ background-color: var(--danger-color); color:#fff; }
    .btn-danger:hover{ background-color:#c0392b; }

    /* Produkty (kafelkowy widok do zamówień) */
    .order-toolbar { display:flex; align-items:center; gap:12px; margin-bottom:16px; flex-wrap:wrap; }
    .order-search { flex:1; display:flex; gap:10px; }
    .order-search input {
      width:100%; padding:14px 16px; border:2px solid #e0e0e0; border-radius:12px; font-size:1rem; background:#fff;
    }
    .order-search input:focus { outline:none; border-color: var(--primary-color); }

    .order-grid { display:grid; grid-template-columns: repeat(5, minmax(0, 1fr)); gap:14px; }
    @media (max-width: 1300px) { .order-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); } }
    @media (max-width: 1024px) { .order-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    @media (max-width: 768px)  { .order-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (max-width: 480px)  { .order-grid { grid-template-columns: repeat(1, minmax(0, 1fr)); } }

    .mini-product {
      background:#fff; border-radius:16px; box-shadow: var(--shadow); overflow:hidden; display:flex; flex-direction:column; padding:12px; gap:10px;
    }
    .mini-product img { width:100%; height:80px; object-fit:cover; border-radius:12px; }
    .mini-product .name { font-weight:700; font-size:.95rem; line-height:1.2; }
    .mini-product .meta { font-size:.85rem; opacity:.75; display:flex; justify-content:space-between; }
    .mini-product .actions { display:flex; gap:8px; align-items:center; }
    .mini-product .qty { width:64px; text-align:center; padding:8px; border:2px solid #eee; border-radius:10px; }
    .mini-product .qty:focus { outline:none; border-color: var(--primary-color); }
    .mini-product .btn { padding:8px 12px; border-radius:12px; }

    /* Pasek podsumowania – zawsze widoczny */
    .sticky-summary-bar {
      position: fixed; left: 280px; right: 0; bottom: 0; z-index: 1000; /* Zmieniony Z-index i left */
      padding: 10px 24px; background: rgba(255,255,255,.9); backdrop-filter: blur(6px); border-top: 1px solid #eee;
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      transition: left .3s ease-in-out;
    }
    .sticky-summary-bar .info { font-weight:700; }

    /* Logowanie */
    #login-view { display:flex; align-items:center; justify-content:center; width:100vw; height:100vh; padding: 20px; }
    .login-card { background:#fff; padding:40px; border-radius:var(--border-radius); box-shadow:var(--shadow); text-align:center; width:100%; max-width:400px; }
    .login-card img{ width:80px; height:80px; border-radius:12px; margin-bottom:20px; }
    .title{ font-weight:700; font-size:1.5rem; color: var(--text-color-dark); }
    .subtitle{ font-size:.9rem; opacity:.7; margin-bottom:30px; }
    #login-form { display:flex; flex-direction:column; }
    #login-input { width:100%; padding:15px; border:2px solid #e0e0e0; border-radius:12px; font-family:'Poppins', sans-serif; font-size:1rem; margin-bottom:20px; text-align:center; }
    #login-button { padding:15px; border-radius:50px; font-weight:600; cursor:pointer; transition: all .3s ease; border:none; background: var(--primary-color); color:#fff; }
    #error-message { color:#e74c3c; margin-top:15px; display:none; font-weight:600; }

    /* NOWE: Style dla okien modalnych */
    .modal {
      position: fixed; inset: 0; z-index: 2000; display: flex; align-items: center; justify-content: center;
      background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px);
    }
    .modal-content {
      background: #fff; padding: 30px; border-radius: var(--border-radius); box-shadow: var(--shadow);
      width: 90vw; max-width: 500px; max-height: 90vh; overflow-y: auto;
    }
    .modal .form-group { margin-bottom: 15px; }
    .modal .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
    .modal input, .modal select {
      width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 12px; font-family: inherit; font-size: 1rem;
    }
    .modal input:focus, .modal select:focus { outline: none; border-color: var(--primary-color); }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px; }

    /* NOWE: Style dla listy produktów i pracowników */
    .grid-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }
    .product-card {
      display: flex; flex-direction: column; padding: 15px;
    }
    .product-card img { width: 100%; height: 150px; object-fit: cover; border-radius: 12px; margin-bottom: 15px; }
    .product-card-content { display: flex; flex-direction: column; flex-grow: 1; }
    .product-card-name { font-size: 1.1rem; font-weight: 700; margin-bottom: 5px; }
    .product-card-content p { opacity: 0.7; margin-bottom: 15px; flex-grow: 1; }
    .product-card-actions { display: flex; gap: 10px; }
    .product-card-actions .btn { flex: 1; padding: 10px; }

    #employees-list .employee-item, #reservations-list .employee-item {
      display: flex; justify-content: space-between; align-items: center; padding: 15px 0;
      border-bottom: 1px solid #eee;
    }
    #employees-list .employee-item:last-child, #reservations-list .employee-item:last-child { border-bottom: none; }
    .employee-item-name { font-weight: 600; }
    .employee-item-details { font-size: 0.9rem; opacity: 0.8; }

    /* NOWE: Style dla nakładki (overlay) */
    .overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.4);
        z-index: 1000; opacity: 0; visibility: hidden;
        transition: opacity .3s ease-in-out, visibility .3s ease-in-out;
    }
    .overlay.is-visible {
        opacity: 1; visibility: visible;
    }

    /* Responsywność */
    @media (max-width: 800px) {
      .sidebar{ position: fixed; left:0; top:0; height:100%; z-index:1001; transform: translateX(-100%); }
      .sidebar.is-open { transform: translateX(0); }
      .main-content{ padding:20px; }
      .main-header{ display:flex; }
      /* Zaktualizowane style dla paska na mobile */
      .sticky-summary-bar { left: 0; padding: 10px 15px; }
    }
  </style>
</head>
<body>
  <div id="login-view">
    <div class="login-card">
      <img src="https://i.imgur.com/EV2m6BO.jpeg" alt="logo" />
      <div class="title">MilkShake System</div>
      <div class="subtitle">Wersja 1.1</div>
      <form id="login-form">
        <input type="text" id="login-input" placeholder="Wprowadź swój login" required />
        <button type="submit" id="login-button">Zaloguj się</button>
      </form>
      <div id="error-message"></div>
    </div>
  </div>

  <div class="admin-wrapper" style="display:none;">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <img src="https://i.imgur.com/EV2m6BO.jpeg" alt="logo" />
        <div class="title-block">
          <div id="user-name" class="title"></div>
          <div class="subtitle">Zalogowany</div>
        </div>
      </div>
      <nav id="main-nav" class="sidebar-nav">
        <a href="#nowe-zamowienie" class="nav-link active"><i class="fas fa-plus-circle"></i><span>Nowe Zamówienie</span></a>
        <a href="#zamowienia" class="nav-link"><i class="fas fa-clipboard-list"></i><span>Zamówienia</span></a>
        <a href="#rezerwacje" class="nav-link"><i class="fas fa-calendar-alt"></i><span>Rezerwacje</span></a>
        <a href="#pracownicy" class="nav-link"><i class="fas fa-users"></i><span>Pracownicy</span></a>
        <a href="#produkty" class="nav-link"><i class="fas fa-box-open"></i><span>Produkty</span></a>
        <a href="#finanse" class="nav-link"><i class="fas fa-dollar-sign"></i><span>Finanse</span></a>
        <a href="#aktywnosc" class="nav-link"><i class="fas fa-chart-line"></i><span>Aktywność</span></a>
      </nav>
      <div class="sidebar-footer" style="padding: 20px 0; margin-top: auto;">
        <a href="#" id="logout-btn" class="nav-link" style="background-color: rgba(255, 107, 107, 0.1); color: #FF6B6B;">
          <i class="fas fa-sign-out-alt"></i><span>Wyloguj się</span>
        </a>
      </div>
    </aside>

    <div class="overlay" id="overlay"></div>

    <main class="main-content">
      <header class="main-header">
        <button id="menu-toggle" class="menu-toggle-btn"><i class="fas fa-bars"></i></button>
      </header>

      <section id="content-nowe-zamowienie" class="content-section">
        <div class="section-header">
          <h1 class="section-title">Nowe Zamówienie</h1>
        </div>
        <div class="order-toolbar">
          <div class="order-search">
            <input id="order-search-input" type="text" placeholder="Szukaj po nazwie produktu..." aria-label="Szukaj produktu" />
          </div>
        </div>
        <div id="order-products-grid" class="order-grid"></div>
      </section>

      <section id="content-order-summary" class="content-section" style="display:none;"></section>

      <section id="content-zamowienia" class="content-section" style="display:none;">
        <h1 class="section-title">Historia Zamówień</h1>
        <div id="orders-list"></div>
      </section>

      <section id="content-rezerwacje" class="content-section" style="display:none;">
        <div class="section-header">
            <h1 class="section-title">Rezerwacje</h1>
        </div>
        <div id="reservations-list" class="card">
            </div>
      </section>

      <section id="content-pracownicy" class="content-section" style="display:none;">
        <div class="section-header">
          <h1 class="section-title">Lista pracowników</h1>
          <button id="add-employee-btn" class="btn btn-primary"><i class="fas fa-plus"></i><span>Dodaj pracownika</span></button>
        </div>
        <div id="employees-list" class="card"></div>
      </section>

      <section id="content-produkty" class="content-section" style="display:none;">
        <div class="section-header">
          <h1 class="section-title">Lista produktów</h1>
          <button id="add-product-btn" class="btn btn-primary"><i class="fas fa-plus"></i><span>Dodaj produkt</span></button>
        </div>
        <div id="products-list" class="grid-container"></div>
      </section>

      <section id="content-finanse" class="content-section" style="display:none;">
        <h1 class="section-title">Finanse</h1>
        <p>Ta sekcja jest w budowie.</p>
      </section>

      <section id="content-aktywnosc" class="content-section" style="display:none;">
        <h1 class="section-title">Dziennik Aktywności</h1>
        <p>Ta sekcja jest w budowie.</p>
      </section>
    </main>
  </div>

  <div id="add-product-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <h2 class="section-title" style="text-align:center; font-size:2rem;">Dodaj nowy produkt</h2>
      <form id="add-product-form">
        <div class="form-group"><input type="text" name="name" placeholder="Nazwa Produktu" required /></div>
        <div class="form-group">
          <label for="add-product-category">Kategoria</label>
          <select name="category" id="add-product-category" required></select>
        </div>
        <div class="form-group">
          <label for="imageFile">Zdjęcie produktu</label>
          <input type="file" name="imageFile" id="imageFile" accept="image/*" required />
        </div>
        <div class="form-group"><input type="text" name="supplier" placeholder="Dostawca" /></div>
        <div class="form-group"><input type="number" name="pricePerUnit" step="0.01" placeholder="Cena za jednostkę" required /></div>
        <div class="form-group">
          <select name="unit" required>
            <option value="" disabled selected>Wybierz jednostkę...</option>
            <option value="szt">szt</option>
            <option value="Kg">Kg</option>
            <option value="L">L</option>
            <option value="Op">Op</option>
          </select>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" data-close-modal>Anuluj</button>
          <button type="submit" class="btn btn-primary">Dodaj produkt</button>
        </div>
      </form>
    </div>
  </div>

  <div id="edit-product-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <h2 class="section-title" style="text-align:center; font-size:2rem;">Edytuj produkt</h2>
      <form id="edit-product-form">
        <input type="hidden" id="edit-product-id" name="id" />
        <div class="form-group">
          <label for="edit-product-name">Nazwa produktu</label>
          <input type="text" id="edit-product-name" name="name" required />
        </div>
        <div class="form-group">
          <label for="edit-product-category">Kategoria</label>
          <select name="category" id="edit-product-category" required></select>
        </div>
        <div class="form-group">
          <label for="edit-imageFile">Zmień zdjęcie (opcjonalnie)</label>
          <input type="file" name="imageFile" id="edit-imageFile" accept="image/*" />
        </div>
        <div class="form-group">
          <label for="edit-product-supplier">Dostawca</label>
          <input type="text" id="edit-product-supplier" name="supplier" />
        </div>
        <div class="form-group">
          <label for="edit-product-price">Cena za jednostkę</label>
          <input type="number" id="edit-product-price" name="pricePerUnit" step="0.01" required />
        </div>
        <div class="form-group">
          <label for="edit-product-unit">Jednostka</label>
          <select id="edit-product-unit" name="unit" required>
            <option value="szt">szt</option>
            <option value="Kg">Kg</option>
            <option value="L">L</option>
            <option value="Op">Op</option>
          </select>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" data-close-modal>Anuluj</button>
          <button type="submit" class="btn btn-primary">Zapisz zmiany</button>
        </div>
      </form>
    </div>
  </div>

  <div id="add-employee-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <h2 class="section-title" style="text-align:center; font-size:2rem;">Dodaj pracownika</h2>
      <form id="add-employee-form">
        <div class="form-group"><input type="text" name="name" placeholder="Nazwa użytkownika" required /></div>
        <div class="form-group"><input type="text" name="login" placeholder="Login" required /></div>
        <div class="form-group">
          <select name="position" required>
            <option value="" disabled selected>Wybierz stanowisko...</option>
            <option value="Właściciel">Właściciel</option>
            <option value="Manager">Manager</option>
            <option value="Szef kuchni">Szef kuchni</option>
            <option value="Kucharz">Kucharz</option>
            <option value="Pomoc kuchenna">Pomoc kuchenna</option>
            <option value="Kelner/ka">Kelner/ka</option>
            <option value="Praktykant/ka">Praktykant/ka</option>
          </select>
        </div>
        <div class="form-group">
          <select name="workplace" required>
            <option value="" disabled selected>Wybierz miejsce pracy...</option>
            <option value="Kuchnia">Kuchnia</option>
            <option value="Bar">Bar</option>
            <option value="Wszystkie">Wszystkie</option>
          </select>
        </div>
        <div class="form-group"><input type="number" step="0.01" name="hourlyRate" placeholder="Stawka godzinowa (np. 30.50)" required /></div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" data-close-modal>Anuluj</button>
          <button type="submit" class="btn btn-primary">Dodaj</button>
        </div>
      </form>
    </div>
  </div>

  <div id="sticky-summary-bar" class="sticky-summary-bar" style="display:none;">
    <div class="info"><span id="cart-count">0</span> w koszyku • Razem: <span id="cart-total">0.00</span> PLN</div>
    <div class="actions">
      <button id="open-summary-btn" class="btn btn-primary"><i class="fa-solid fa-receipt"></i> Podsumowanie</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const loginView = document.getElementById('login-view');
      const appView = document.querySelector('.admin-wrapper');
      const loginForm = document.getElementById('login-form');
      const logoutBtn = document.getElementById('logout-btn');
      const API_URL = `${window.location.origin}/api`;

      let loggedInUser = null;
      let shoppingCart = [];

      // Helpers
      const fmt = (n) => (isNaN(n) ? '0.00' : Number(n).toFixed(2));
      const apiFetch = async (endpoint, options = {}) => {
        try {
          const res = await fetch(`${API_URL}${endpoint}`, options);
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.message || 'Błąd serwera');
          }
          if (res.status === 204) return null;
          return res.json();
        } catch (e) {
          console.error('API error:', endpoint, e);
          alert(`Wystąpił błąd: ${e.message}`);
          return null;
        }
      };

      // Logowanie
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const loginInput = document.getElementById('login-input');
        const errorMessage = document.getElementById('error-message');
        errorMessage.style.display = 'none';
        try {
          const response = await fetch(`${API_URL}/login`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ login: loginInput.value })
          });
          const userData = await response.json();
          if (!response.ok) throw new Error(userData.message || 'Błąd logowania');
          localStorage.setItem('loggedInUser', JSON.stringify(userData));
          initializeApp(userData);
        } catch (error) {
          errorMessage.textContent = error.message;
          errorMessage.style.display = 'block';
        }
      });

      const handleLogout = (e) => {
        e.preventDefault();
        localStorage.removeItem('loggedInUser');
        loggedInUser = null;
        appView.style.display = 'none';
        loginView.style.display = 'flex';
      };
      logoutBtn.addEventListener('click', handleLogout);

      // Nawigacja
      const contentSections = () => document.querySelectorAll('.content-section');
      const navLinks = () => document.querySelectorAll('.nav-link');
      const sidebar = () => document.getElementById('sidebar');
      const overlay = () => document.getElementById('overlay');

      const navigateTo = (hash) => {
        const cleanHash = hash ? hash.substring(1) : 'nowe-zamowienie';
        contentSections().forEach((s) => (s.style.display = 'none'));
        const active = document.getElementById(`content-${cleanHash}`);
        if (active) active.style.display = 'block';
        navLinks().forEach((l) => l.classList.toggle('active', l.getAttribute('href') === `#${cleanHash}`));
        
        if (window.innerWidth <= 800) {
            sidebar().classList.remove('is-open');
            overlay().classList.remove('is-visible');
        }

        document.getElementById('sticky-summary-bar').style.display = cleanHash === 'nowe-zamowienie' ? 'flex' : 'none';

        switch (cleanHash) {
          case 'nowe-zamowienie':
            renderOrderBrowse();
            break;
          case 'zamowienia':
            renderOrdersHistory();
            break;
          case 'rezerwacje': // <-- NOWY ROUTING
            renderReservations();
            break;
          case 'pracownicy':
            renderEmployees();
            break;
          case 'produkty':
            renderAllProducts();
            break;
        }
      };

      // NOWE ZAMÓWIENIE – widok przeglądania
      let allProductsCache = [];
      const renderOrderBrowse = async () => {
        const grid = document.getElementById('order-products-grid');
        const searchInput = document.getElementById('order-search-input');

        if (!allProductsCache.length) {
          const products = await apiFetch('/produkty');
          allProductsCache = Array.isArray(products) ? products : [];
        }

        const renderTiles = (list) => {
          if (!list.length) {
            grid.innerHTML = '<div class="card" style="grid-column:1/-1;">Brak produktów do wyświetlenia.</div>';
            return;
          }
          grid.innerHTML = list
            .map((p) => `
              <div class="mini-product" data-id="${p._id}">
                <img src="${p.imageUrl}" alt="${p.name}" />
                <div class="name">${p.name}</div>
                <div class="meta"><span>${p.unit}</span><span>${fmt(p.pricePerUnit)} PLN</span></div>
                <div class="actions">
                  <input class="qty" type="number" min="1" value="1" />
                  <button class="btn btn-primary btn-add">Zamów</button>
                </div>
              </div>
            `)
            .join('');
        };

        const applyFilter = () => {
          const q = (searchInput.value || '').trim().toLowerCase();
          const filtered = !q
            ? allProductsCache
            : allProductsCache.filter((p) => p.name.toLowerCase().includes(q));
          renderTiles(filtered);
        };

        applyFilter();
        searchInput.oninput = applyFilter;

        grid.onclick = (e) => {
          const btn = e.target.closest('.btn-add');
          if (!btn) return;
          const card = btn.closest('.mini-product');
          const id = card.dataset.id;
          const product = allProductsCache.find((x) => x._id === id);
          const qtyInput = card.querySelector('.qty');
          const quantity = Math.max(1, parseFloat(qtyInput.value || '1'));

          const existing = shoppingCart.find((x) => x._id === id);
          if (existing) existing.quantity += quantity; else shoppingCart.push({ ...product, quantity });
          updateStickyBar();

          btn.innerHTML = '<i class="fa-solid fa-check"></i> Dodano';
          setTimeout(() => (btn.textContent = 'Zamów'), 800);
        };
      };

      // Sticky podsumowanie (dolny pasek)
      const updateStickyBar = () => {
        const count = shoppingCart.reduce((acc, it) => acc + it.quantity, 0);
        const total = shoppingCart.reduce((acc, it) => acc + it.quantity * (it.pricePerUnit || 0), 0);
        document.getElementById('cart-count').textContent = count;
        document.getElementById('cart-total').textContent = fmt(total);
      };
      document.getElementById('open-summary-btn').addEventListener('click', () => showOrderSummary());

      // Podsumowanie i złożenie zamówienia
      const showOrderSummary = () => {
        const container = document.getElementById('content-order-summary');
        let totalPrice = 0;
        let html = `<h1 class="section-title">Podsumowanie zamówienia</h1>`;
        if (!shoppingCart.length) {
          html += '<p>Koszyk jest pusty.</p>';
        } else {
          html += shoppingCart
            .map((item, idx) => {
              const itemTotal = (item.pricePerUnit || 0) * (item.quantity || 0);
              totalPrice += itemTotal;
              return `
                <div class="summary-item">
                  <div>
                    <div class="summary-item-info">${item.name}</div>
                    <div class="summary-item-details">${item.quantity} ${item.unit} × ${fmt(item.pricePerUnit)} PLN</div>
                  </div>
                  <div class="summary-item-total"><b>${fmt(itemTotal)} PLN</b></div>
                </div>`;
            })
            .join('');
          html += `<div class="summary-total">Łącznie: ${fmt(totalPrice)} PLN</div>`;
          html += `<div class="bottom-bar" style="margin-top:16px;">
            <button id="submit-order-btn" class="btn btn-primary"><i class="fa-solid fa-paper-plane"></i> Złóż zamówienie</button>
          </div>`;
        }
        container.innerHTML = html;
        document.querySelectorAll('.content-section').forEach((s) => (s.style.display = 'none'));
        container.style.display = 'block';
        document.getElementById('sticky-summary-bar').style.display = 'none';

        const submitBtn = document.getElementById('submit-order-btn');
        if (submitBtn) {
          submitBtn.addEventListener('click', async () => {
            const orderData = {
              items: shoppingCart.map((p) => ({
                productId: p._id,
                name: p.name,
                quantity: p.quantity,
                unit: p.unit,
                priceAtOrder: p.pricePerUnit,
                orderDay: null,
              })),
              totalPrice: shoppingCart.reduce((acc, it) => acc + (it.quantity || 0) * (it.pricePerUnit || 0), 0),
              orderedBy: loggedInUser?.login || 'unknown',
            };
            const result = await apiFetch('/zamowienia', {
              method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(orderData),
            });
            if (result) {
              alert('Zamówienie zostało pomyślnie złożone!');
              shoppingCart = [];
              updateStickyBar();
              window.location.hash = '#zamowienia';
            }
          });
        }
      };

      const renderOrdersHistory = async () => {
        const orders = await apiFetch('/zamowienia');
        const container = document.getElementById('orders-list');
        if (!orders || !orders.length) {
          container.innerHTML = '<p>Brak historii zamówień.</p>';
          return;
        }
        container.innerHTML = orders
          .map(
            (order) => `
          <div class="card">
            <h4>Zamówienie z ${new Date(order.createdAt).toLocaleString('pl-PL')}</h4>
            <p>Złożone przez: <b>${order.orderedBy}</b></p>
            <p>Wartość: <b>${fmt(order.totalPrice)} PLN</b></p>
          </div>`
          )
          .join('');
      };

      // --- Rezerwacje ---
      const renderReservations = async () => {
          const reservations = await apiFetch('/rezerwacje');
          const container = document.getElementById('reservations-list');

          if (!reservations || !reservations.length) {
              container.innerHTML = '<p style="text-align:center; padding: 20px;">Brak nadchodzących rezerwacji.</p>';
              return;
          }

          // Funkcja pomocnicza do formatowania daty
          const formatReservationDate = (isoDate) => {
              const date = new Date(isoDate);
              return date.toLocaleString('pl-PL', {
                  year: 'numeric', month: 'long', day: 'numeric',
                  hour: '2-digit', minute: '2-digit',
                  weekday: 'long'
              });
          };

          container.innerHTML = reservations.map(res => `
              <div class="employee-item" style="align-items: flex-start; padding: 20px;">
                  <div>
                      <div class="employee-item-name">${res.customerName} - ${res.tableName}</div>
                      <div class="employee-item-details" style="margin-top: 8px;">
                          <span style="display:block;">📞 Telefon: <b>${res.customerPhone}</b></span>
                          <span style="display:block;">👥 Gości: <b>${res.numberOfGuests}</b></span>
                          <span style="display:block;">🗓️ Data: <b>${formatReservationDate(res.reservationDate)}</b></span>
                      </div>
                  </div>
                  <div style="text-align: right;">
                      <span class="badge" style="background-color: ${res.status === 'Potwierdzona' ? '#27ae60' : '#f39c12'}; color: white; padding: 5px 10px; border-radius: 20px; font-weight: 600;">
                          ${res.status}
                      </span>
                  </div>
              </div>
          `).join('');
      };

      // PRACOWNICY / PRODUKTY
      const renderEmployees = async () => {
        const employees = await apiFetch('/pracownicy');
        const container = document.getElementById('employees-list');
        if (!employees || !employees.length) {
          container.innerHTML = '<p>Brak pracowników w systemie.</p>';
          return;
        }
        container.innerHTML = employees
          .map(
            (user) => `
          <div class="employee-item">
            <div class="employee-item-name">${user.name} (${user.position})</div>
            <div class="employee-item-details"><span>Stawka: <b>${fmt(user.hourlyRate)} zł/h</b></span></div>
          </div>`
          )
          .join('');
      };

      const renderAllProducts = async () => {
        const products = await apiFetch('/produkty');
        const container = document.getElementById('products-list');
        if (!products || !products.length) {
          container.innerHTML = '<p>Brak produktów w systemie.</p>';
          return;
        }
        container.innerHTML = products
          .map(
            (prod) => `
          <div class="card product-card">
            <img src="${prod.imageUrl}" alt="${prod.name}" />
            <div class="product-card-content">
              <h3 class="product-card-name">${prod.name}</h3>
              <p>${prod.category}</p>
              <div class="product-card-actions">
                <button class="btn btn-secondary btn-edit" data-id="${prod._id}">Edytuj</button>
                <button class="btn btn-danger btn-delete" data-id="${prod._id}">Usuń</button>
              </div>
            </div>
          </div>`
          )
          .join('');
      };

      // Modale
      const setupModal = (modalId, openBtnId, formId, submitFn) => {
        const modal = document.getElementById(modalId);
        const openBtn = document.getElementById(openBtnId);
        const form = document.getElementById(formId);
        if (!modal || !openBtn || !form) return;
        openBtn.addEventListener('click', () => (modal.style.display = 'flex'));
        modal.addEventListener('click', (e) => {
          if (e.target.classList.contains('modal') || e.target.hasAttribute('data-close-modal')) modal.style.display = 'none';
        });
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          await submitFn(form);
          modal.style.display = 'none';
          form.reset();
        });
      };

      const STATIC_CATEGORIES = [
          { name: 'Mroźnia 1', desc: '(Frytki)' }, { name: 'Mroźnia 2', desc: '(Bar)' }, { name: 'Mroźnia 3', desc: '(Mięso)' },
          { name: 'Mroźnia 4', desc: '(Produkty)' }, { name: 'Chłodnia', desc: '' }, { name: 'Magazyn Suchy', desc: '' },
          { name: 'Magazyn Suchy', desc: '(Bar)' }, { name: 'Opakowania', desc: '' }, { name: 'Warzywa i Owoce', desc: '' },
          { name: 'Mix', desc: '' },
      ];

      const populateCategorySelects = () => {
        const selects = [document.getElementById('add-product-category'), document.getElementById('edit-product-category')];
        selects.forEach((select) => {
          if (!select) return;
          select.innerHTML = '<option value="" disabled selected>Wybierz kategorię...</option>';
          STATIC_CATEGORIES.forEach((cat) => {
            const opt = document.createElement('option');
            opt.value = cat.name; opt.textContent = cat.name; select.appendChild(opt);
          });
        });
      };

      setupModal('add-product-modal', 'add-product-btn', 'add-product-form', async (form) => {
        const formData = new FormData(form);
        await apiFetch('/produkty', { method: 'POST', body: formData });
        allProductsCache = [];
        renderAllProducts();
      });

      document.getElementById('products-list').addEventListener('click', async (e) => {
        const target = e.target;
        const id = target.dataset.id;
        if (target.classList.contains('btn-delete')) {
          if (confirm('Czy na pewno chcesz usunąć ten produkt?')) {
            await apiFetch(`/produkty/${id}`, { method: 'DELETE' });
            allProductsCache = [];
            renderAllProducts();
          }
        }
        if (target.classList.contains('btn-edit')) {
          const product = await apiFetch(`/produkty/${id}`);
          if (!product) return;
          const modal = document.getElementById('edit-product-modal');
          document.getElementById('edit-product-id').value = product._id;
          document.getElementById('edit-product-name').value = product.name;
          document.getElementById('edit-product-category').value = product.category;
          document.getElementById('edit-product-supplier').value = product.supplier || '';
          document.getElementById('edit-product-price').value = product.pricePerUnit;
          document.getElementById('edit-product-unit').value = product.unit;
          modal.style.display = 'flex';
        }
      });

      document.getElementById('edit-product-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('edit-product-id').value;
        const formData = new FormData(e.target);
        await apiFetch(`/produkty/${id}`, { method: 'PUT', body: formData });
        allProductsCache = [];
        document.getElementById('edit-product-modal').style.display = 'none';
        renderAllProducts();
      });
      
      // ... Inne modale (np. pracownicy) jeśli są potrzebne ...

      // Start aplikacji
      const initializeApp = (user) => {
        loggedInUser = user;
        loginView.style.display = 'none';
        appView.style.display = 'flex';
        document.getElementById('user-name').textContent = user.name;
        populateCategorySelects();

        const mainNav = document.getElementById('main-nav');
        mainNav.addEventListener('click', (e) => {
          const link = e.target.closest('a');
          if (!link) return;
          e.preventDefault();
          window.location.hash = link.getAttribute('href');
        });

        const menuToggleBtn = document.getElementById('menu-toggle');
        const mobileSidebar = document.getElementById('sidebar');
        const mobileOverlay = document.getElementById('overlay');

        const toggleMenu = () => {
            mobileSidebar.classList.toggle('is-open');
            mobileOverlay.classList.toggle('is-visible');
        }

        menuToggleBtn.addEventListener('click', toggleMenu);
        mobileOverlay.addEventListener('click', toggleMenu);


        window.addEventListener('hashchange', () => navigateTo(window.location.hash));
        navigateTo(window.location.hash || '#nowe-zamowienie');
        updateStickyBar();
      };

      // Autologin
      const storedUser = localStorage.getItem('loggedInUser');
      if (storedUser) initializeApp(JSON.parse(storedUser)); else loginView.style.display = 'flex';
    });
  </script>
</body>
</html>
