<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MilkShake System 1.0</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root{--primary-color:#00A79D;--secondary-color:#FF6B6B;--danger-color:#e74c3c;--background-light:#FFF8E7;--background-dark:#003B46;--text-color-dark:#07575B;--text-color-light:#f5f5f5;--gradient-bg:linear-gradient(135deg,var(--primary-color),var(--secondary-color));--shadow:0 10px 30px rgba(0,0,0,.1);--border-radius:20px}*,::after,::before{box-sizing:border-box;margin:0;padding:0}html{scroll-behavior:smooth}body{font-family:'Poppins',sans-serif;color:var(--text-color-dark);background-color:var(--background-light);overflow-x:hidden}.admin-wrapper{display:flex;min-height:100vh}.sidebar{width:280px;flex-shrink:0;background-color:var(--background-dark);color:var(--text-color-light);display:flex;flex-direction:column;padding:20px;transition:transform .3s ease-in-out}.sidebar-header{display:flex;align-items:center;gap:15px;padding:10px;margin-bottom:30px}.sidebar-header img{width:50px;height:50px;border-radius:12px}.sidebar-header .title-block{line-height:1.2}.sidebar-header .title{font-weight:700;font-size:1.2rem;color:#fff}.sidebar-header .subtitle{font-size:.8rem;opacity:.7}.sidebar-nav{list-style:none;flex-grow:1}.nav-link{display:flex;align-items:center;gap:15px;padding:18px 20px;margin-bottom:10px;border-radius:12px;text-decoration:none;color:var(--text-color-light);font-weight:600;transition:all .3s ease}.nav-link:hover{background-color:rgba(255,255,255,.1)}.nav-link.active{background:var(--gradient-bg);color:#fff;box-shadow:0 4px 20px rgba(0,167,157,.4);transform:scale(1.02)}.nav-link i{width:20px;text-align:center}.main-content{flex-grow:1;padding:40px;overflow-y:auto;display:flex;flex-direction:column}.main-header{display:none;align-items:center;gap:20px;margin-bottom:20px}.menu-toggle-btn{background:#fff;border:none;width:50px;height:50px;border-radius:50%;box-shadow:var(--shadow);color:var(--primary-color);font-size:1.2rem;cursor:pointer}.section-title{font-size:clamp(2rem,4vw,2.5rem);font-weight:900;margin-bottom:30px;background:var(--gradient-bg);-webkit-background-clip:text;-webkit-text-fill-color:transparent}.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;flex-wrap:wrap;gap:15px}.section-header .section-title{margin:0}.card{background:#fff;padding:30px;border-radius:var(--border-radius);box-shadow:var(--shadow);margin-bottom:25px}.btn{padding:14px 30px;border-radius:50px;font-weight:600;text-decoration:none;cursor:pointer;transition:all .3s ease;border:none;display:inline-flex;align-items:center;justify-content:center;gap:10px}.btn-primary{background:var(--gradient-bg);color:#fff;box-shadow:0 4px 20px rgba(0,167,157,.4)}.btn-primary:hover{transform:translateY(-5px);box-shadow:0 8px 25px rgba(0,167,157,.6)}.btn-secondary{background:#eee;color:var(--text-color-dark)}.btn-secondary:hover{background:#ddd}.btn-danger{background-color:var(--danger-color);color:#fff}.btn-danger:hover{background-color:#c0392b}.grid-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:30px}.product-card{overflow:hidden;transition:transform .3s ease,box-shadow .3s ease;display:flex;flex-direction:column}.product-card:hover{transform:translateY(-10px)}.product-card img{width:100%;height:200px;object-fit:cover}.product-card-content{padding:20px;flex-grow:1;display:flex;flex-direction:column}.product-card-name{font-weight:700;font-size:1.3rem;flex-grow:1}.product-card-actions{display:flex;gap:10px;margin-top:20px}.product-card-actions .btn{flex:1;padding:10px}.modal{position:fixed;inset:0;z-index:1000;display:none;align-items:center;justify-content:center;background-color:rgba(0,59,70,.6);backdrop-filter:blur(5px)}.modal-content{background:#fff;border-radius:var(--border-radius);box-shadow:var(--shadow);width:100%;max-width:600px;padding:40px;max-height:90vh;overflow-y:auto}.form-group{margin-bottom:20px}.form-group label{display:block;margin-bottom:8px;font-weight:600;font-size:.9rem}.form-group input,.form-group select{width:100%;padding:15px 20px;border:2px solid #e0e0e0;border-radius:12px;font-family:'Poppins',sans-serif;font-size:1rem;transition:border-color .3s ease;background:#f9f9f9}.form-group input:focus,.form-group select:focus{outline:none;border-color:var(--primary-color)}.modal-actions{display:flex;justify-content:flex-end;gap:15px;margin-top:30px}#login-view{display:flex;align-items:center;justify-content:center;width:100vw;height:100vh}.login-card{background:#fff;padding:40px;border-radius:var(--border-radius);box-shadow:var(--shadow);text-align:center;width:100%;max-width:400px}.login-card img{width:80px;height:80px;border-radius:12px;margin-bottom:20px}.title{font-weight:700;font-size:1.5rem;color:var(--text-color-dark)}.subtitle{font-size:.9rem;opacity:.7;margin-bottom:30px}#login-form{display:flex;flex-direction:column}#login-input{width:100%;padding:15px;border:2px solid #e0e0e0;border-radius:12px;font-family:'Poppins',sans-serif;font-size:1rem;margin-bottom:20px;text-align:center}#login-input:focus{outline:none;border-color:var(--primary-color)}#login-button{padding:15px;border-radius:50px;font-weight:600;cursor:pointer;transition:all .3s ease;border:none;background:var(--primary-color);color:#fff}#login-button:hover{transform:translateY(-3px)}#error-message{color:#e74c3c;margin-top:15px;display:none;font-weight:600}
        /* NOWE STYLE DLA SEKCJI ZAMAWIANIA */
        #product-search-input{width:100%;padding:15px 20px;border:2px solid #e0e0e0;border-radius:12px;font-size:1rem;margin-bottom:30px}.grid-container-small{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:20px}.product-tile-small{background:#fff;border-radius:var(--border-radius);box-shadow:var(--shadow);text-align:center;padding:15px;display:flex;flex-direction:column;transition:all .3s ease}.product-tile-small:hover{transform:translateY(-5px);box-shadow:0 8px 25px rgba(0,0,0,.1)}.product-tile-small img{width:100%;height:120px;object-fit:cover;border-radius:10px;margin-bottom:10px}.product-tile-small h4{font-size:1rem;font-weight:600;margin-bottom:10px;flex-grow:1}.product-tile-small .btn{width:100%;padding:10px}.floating-cart-btn{position:fixed;bottom:30px;right:30px;z-index:100;padding:20px;border-radius:50%;width:80px;height:80px;flex-direction:column;font-size:.8rem;box-shadow:0 10px 30px rgba(0,0,0,.2)}.summary-item{display:flex;justify-content:space-between;align-items:center;padding:15px 0;border-bottom:1px solid #eee}.summary-item-info{font-weight:600}.summary-item-details{font-size:.9rem;color:#777}.summary-total{margin-top:30px;text-align:right;font-size:1.5rem;font-weight:700}
        @media (max-width:800px){.sidebar{position:fixed;left:0;top:0;height:100%;z-index:1001;transform:translateX(-100%)}.sidebar.is-open{transform:translateX(0)}.main-content{padding:20px}.main-header{display:flex}.section-title{font-size:1.8rem}.modal-content{width:95%;padding:25px}}
    </style>
</head>
<body>

    <div id="login-view" style="display: none;"></div>
    <div class="admin-wrapper" style="display: none;">
        <aside class="sidebar" id="sidebar"></aside>
        <main class="main-content">
            <header class="main-header"><button id="menu-toggle" class="menu-toggle-btn"><i class="fas fa-bars"></i></button></header>
            
            <div id="content-nowe-zamowienie" class="content-section">
                <div class="section-header">
                    <h1 class="section-title">Nowe Zamówienie</h1>
                </div>
                <input type="search" id="product-search-input" placeholder="Wyszukaj produkt po nazwie...">
                <div id="order-product-grid" class="grid-container-small">
                    </div>
                <button id="floating-cart-btn" class="btn btn-primary floating-cart-btn" style="display: none;">
                    <i class="fas fa-shopping-cart"></i>
                    <span id="cart-counter">Koszyk (0)</span>
                </button>
            </div>

            <div id="content-order-summary" class="content-section" style="display: none;">
                 </div>
            
            <div id="content-zamowienia" class="content-section" style="display: none;"><h1 class="section-title">Historia Zamówień</h1><div id="orders-list"></div></div>
            <div id="content-pracownicy" class="content-section" style="display: none;"><div class="section-header"><h1 class="section-title">Lista pracowników</h1><button id="add-employee-btn" class="btn btn-primary"><i class="fas fa-plus"></i><span>Dodaj pracownika</span></button></div><div id="employees-list" class="card"></div></div>
            <div id="content-produkty" class="content-section" style="display: none;"><div class="section-header"><h1 class="section-title">Lista produktów</h1><button id="add-product-btn" class="btn btn-primary"><i class="fas fa-plus"></i><span>Dodaj produkt</span></button></div><div id="products-list" class="grid-container"></div></div>

        </main>
    </div>
    
    <div id="add-product-modal" class="modal"></div>
    <div id="edit-product-modal" class="modal"></div>
    <div id="add-employee-modal" class="modal"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- LOGIKA LOGOWANIA I URUCHAMIANIA APLIKACJI ---
        const loginView = document.getElementById('login-view');
        const appView = document.querySelector('.admin-wrapper');
        const loginForm = document.getElementById('login-form');
        const logoutBtn = document.getElementById('logout-btn');
        let loggedInUser = null;
        const API_URL = `${window.location.origin}/api`;

        const handleLogin = async (e) => { e.preventDefault(); /* ... */ };
        const handleLogout = (e) => { e.preventDefault(); /* ... */ };
        
        const initializeApp = (user) => {
            loggedInUser = user;
            loginView.style.display = 'none';
            appView.style.display = 'flex';
            document.getElementById('user-name').textContent = user.name;
            
            // --- GŁÓWNA LOGIKA APLIKACJI (WEWNĄTRZ INITIALIZEAPP) ---
            let allProducts = [];
            let shoppingCart = [];

            const mainNav = document.getElementById('main-nav');
            const contentSections = document.querySelectorAll('.content-section');
            const navLinks = document.querySelectorAll('.nav-link');
            const productsListContainer = document.getElementById('products-list');

            const apiFetch = async (endpoint, options = {}) => { /* ... */ };
            
            // --- LOGIKA NOWEJ SEKCJI "NOWE ZAMÓWIENIE" ---
            const productSearchInput = document.getElementById('product-search-input');
            const orderProductGrid = document.getElementById('order-product-grid');
            const floatingCartBtn = document.getElementById('floating-cart-btn');
            const cartCounter = document.getElementById('cart-counter');

            const initializeNewOrderView = async () => {
                allProducts = await apiFetch('/produkty');
                renderProductGrid(allProducts);
            };

            const renderProductGrid = (productsToDisplay) => {
                if (!productsToDisplay) return;
                orderProductGrid.innerHTML = productsToDisplay.map(p => `
                    <div class="product-tile-small">
                        <img src="${p.imageUrl}" alt="${p.name}">
                        <h4>${p.name}</h4>
                        <button class="btn btn-primary btn-order" data-id="${p._id}">Zamów</button>
                    </div>
                `).join('');
            };
            
            productSearchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredProducts = allProducts.filter(p => p.name.toLowerCase().includes(searchTerm));
                renderProductGrid(filteredProducts);
            });

            orderProductGrid.addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-order')) {
                    const productId = e.target.dataset.id;
                    const product = allProducts.find(p => p._id === productId);
                    if (product) {
                        const quantity = prompt(`Podaj ilość dla "${product.name}" (jednostka: ${product.unit}):`, "1");
                        if (quantity && !isNaN(quantity) && parseFloat(quantity) > 0) {
                            const existingItem = shoppingCart.find(item => item._id === productId);
                            if (existingItem) {
                                existingItem.quantity += parseFloat(quantity);
                            } else {
                                shoppingCart.push({ ...product, quantity: parseFloat(quantity) });
                            }
                            updateFloatingCartButton();
                        }
                    }
                }
            });

            const updateFloatingCartButton = () => {
                const totalItems = shoppingCart.reduce((sum, item) => sum + item.quantity, 0);
                if (shoppingCart.length > 0) {
                    floatingCartBtn.style.display = 'flex';
                    cartCounter.textContent = `Koszyk (${shoppingCart.length})`;
                } else {
                    floatingCartBtn.style.display = 'none';
                }
            };
            
            floatingCartBtn.addEventListener('click', () => {
                navigateTo('#order-summary');
                showOrderSummary();
            });

            const showOrderSummary = () => {
                const container = document.getElementById('content-order-summary');
                let totalPrice = 0;
                let summaryHTML = `<h1 class="section-title">Podsumowanie zamówienia</h1>`;
                if (shoppingCart.length === 0) {
                    summaryHTML += '<p>Koszyk jest pusty. Wróć do sekcji "Nowe Zamówienie", aby dodać produkty.</p>';
                } else {
                    summaryHTML += shoppingCart.map(item => {
                        const itemTotal = item.pricePerUnit * item.quantity;
                        totalPrice += itemTotal;
                        return `<div class="summary-item">
                            <div>
                                <div class="summary-item-info">${item.name}</div>
                                <div class="summary-item-details">${item.quantity} ${item.unit} &times; ${item.pricePerUnit.toFixed(2)} PLN</div>
                            </div>
                            <div class="summary-item-total"><b>${itemTotal.toFixed(2)} PLN</b></div>
                        </div>`;
                    }).join('');
                    summaryHTML += `<div class="summary-total">Łącznie: ${totalPrice.toFixed(2)} PLN</div>`;
                    summaryHTML += `<div class="bottom-bar"><button id="submit-order-btn" class="btn btn-primary">Złóż zamówienie</button></div>`;
                }
                container.innerHTML = summaryHTML;
                const submitBtn = document.getElementById('submit-order-btn');
                if (submitBtn) {
                    submitBtn.addEventListener('click', async () => {
                        const orderData = {
                            items: shoppingCart.map(p => ({ productId: p._id, name: p.name, quantity: p.quantity, unit: p.unit, priceAtOrder: p.pricePerUnit, orderDay: 'dowolny' })),
                            totalPrice: totalPrice,
                            orderedBy: loggedInUser.login
                        };
                        const result = await apiFetch('/zamowienia', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(orderData) });
                        if (result) {
                            alert('Zamówienie zostało pomyślnie złożone!');
                            shoppingCart = [];
                            updateFloatingCartButton();
                            window.location.hash = '#zamowienia';
                        }
                    });
                }
            };

            const navigateTo = (hash) => {
                const cleanHash = hash ? hash.substring(1) : 'nowe-zamowienie';
                contentSections.forEach(s => s.style.display = 'none');
                const activeSection = document.getElementById(`content-${cleanHash}`);
                if (activeSection) activeSection.style.display = 'block'; else document.getElementById('content-nowe-zamowienie').style.display = 'block';
                navLinks.forEach(l => l.classList.toggle('active', l.getAttribute('href') === `#${cleanHash}`));

                // Pokaż lub ukryj pływający koszyk w zależności od sekcji
                floatingCartBtn.style.display = (cleanHash === 'nowe-zamowienie' && shoppingCart.length > 0) ? 'flex' : 'none';

                switch(cleanHash) {
                    case 'nowe-zamowienie': initializeNewOrderView(); break;
                    case 'zamowienia': renderOrdersHistory(); break;
                    case 'pracownicy': renderEmployees(); break;
                    case 'produkty': renderAllProducts(); break;
                    case 'order-summary': showOrderSummary(); break;
                }
            };
            
            // ... reszta funkcji i event listenerów (renderEmployees, setupModal, etc.) ...
            
            navigateTo(window.location.hash || '#nowe-zamowienie');
        };

        // --- LOGIKA STARTOWA ---
        loginForm.addEventListener('submit', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        const storedUser = localStorage.getItem('loggedInUser');
        if (storedUser) {
            initializeApp(JSON.parse(storedUser));
        } else {
            loginView.style.display = 'flex';
        }
    });
    </script>
</body>
</html>
