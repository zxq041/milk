<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milkshake App - System</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--bg-color:#121212;--panel-bg:rgba(40,40,40,0.7);--border-color:rgba(255,255,255,0.1);--text-primary:#fff;--text-secondary:#a0a0a0;--accent:#6a11cb;--accent-gradient:linear-gradient(45deg,#6a11cb,#2575fc);--success:#2ecc71;--danger:#e74c3c}
        body,html{margin:0;padding:0;font-family:Poppins,sans-serif;background-color:var(--bg-color);color:var(--text-primary)}
        #app{min-height:100vh;display:flex;flex-direction:column}
        *{box-sizing:border-box}
        .container{padding:20px;width:100%;max-width:1200px;margin:0 auto;animation:fadeIn .5s ease}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .panel{background:var(--panel-bg);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid var(--border-color);border-radius:20px;padding:25px;box-shadow:0 8px 32px rgba(0,0,0,.3)}
        .button{width:100%;padding:15px;background:var(--accent-gradient);color:var(--text-primary);font-weight:600;font-size:1rem;border:none;border-radius:12px;cursor:pointer;transition:all .2s ease}
        .button-success{background:var(--success);}
        .button-danger{background:var(--danger);}
        .button:hover{filter:brightness(1.2);transform:scale(1.02)}
        .button:disabled{background:grey;cursor:not-allowed}
        .input{width:100%;border:1px solid #555;background:rgba(0,0,0,.2);border-radius:12px;padding:15px;font-size:1rem;color:var(--text-primary);text-align:center}
        .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;padding-bottom:15px;border-bottom:1px solid var(--border-color)}
        .header h1{margin:0;font-size:clamp(1.5rem,5vw,2rem)}
        .icon-button{background:0 0;border:0;cursor:pointer;padding:10px}
        .icon-svg{stroke:var(--text-primary);width:28px;height:28px}
        .login-view{display:flex;justify-content:center;align-items:center;min-height:100vh}
        .category-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px}
        .category-card{padding:20px;text-align:center;font-weight:600;cursor:pointer;transition:all .2s ease}
        .category-card:hover{transform:scale(1.05);background:var(--panel-bg)}
        .admin-nav{display:flex;flex-wrap: wrap; gap:10px;margin-bottom:20px;border-bottom:1px solid var(--border-color);padding-bottom:20px}
        .admin-nav .button{width:auto;padding:10px 20px;}
        .admin-nav .button.active{background:var(--accent);box-shadow:0 0 15px var(--accent);}
        .employee-list-item{display:flex;align-items:center;padding:15px;margin-bottom:10px;border-radius:12px;transition:background .2s ease;cursor:pointer}
        .employee-list-item:hover{background:rgba(255,255,255,0.05)}
        .status-dot{width:12px;height:12px;border-radius:50%;margin-right:15px;flex-shrink:0;}
        .status-dot.online{background-color:var(--success);box-shadow:0 0 8px var(--success)}
        .status-dot.offline{background-color:#555}
        .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);backdrop-filter:blur(5px);display:flex;justify-content:center;align-items:center;z-index:1000}
        .time-clock-kiosk { padding: 20px; text-align: center; }
        .employee-list-vertical { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; max-width: 600px; margin-left: auto; margin-right: auto;}
        .employee-tile { display: flex; align-items: center; gap: 20px; padding: 20px; font-size: 1.2rem; font-weight: 600; cursor: pointer; border-radius: 15px; background: var(--panel-bg); border: 1px solid var(--border-color); color: var(--text-primary); transition: all .2s ease; }
        .employee-tile:hover { transform: scale(1.02); border-color: var(--accent); }
        .employee-tile-icon { width: 32px; height: 32px; stroke: var(--text-secondary); }
        .clock-modal-content { text-align: center; width: 90%; max-width: 400px; }
        .clock-modal-content .button { margin-top: 15px; }
        .employee-info-grid{display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:20px;}
        .form-group{margin-bottom:15px;text-align:left}
        .form-group label{display:block;margin-bottom:5px;color:var(--text-secondary)}
        .form-group select,.form-group input {width:100%;border:1px solid #555;background-color:rgba(0,0,0,.2);border-radius:12px;padding:15px;font-size:1rem;color:var(--text-primary);font-family:Poppins,sans-serif}
        .swipe-view{display:flex;flex-direction:column;height:calc(100vh - 40px);overflow:hidden}
        .swipe-area{flex-grow:1;display:flex;justify-content:center;align-items:center}
        .swipe-card{position:relative;width:clamp(280px,85vw,350px);height:clamp(400px,70vh,520px);animation:fadeIn .5s;cursor:grab}
        .swipe-card-inner{width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;transition:transform .3s ease-out;text-align:center}
        .product-image{width:150px;height:150px;border-radius:50%;margin-bottom:20px;object-fit:cover;border:2px solid var(--border-color)}
        .product-name{font-size:1.8rem;font-weight:600}
        .cart-item-group{margin-bottom:20px}
        .cart-item-group h3{padding-bottom:10px;border-bottom:1px solid var(--border-color)}
        .cart-item-details {display: flex;flex-direction: column;margin-bottom: 15px;padding-bottom: 10px;border-bottom: 1px solid rgba(255, 255, 255, 0.05);}
        .cart-item-main {display: flex;align-items: center;gap: 15px;font-size: 1.1rem;}
        .cart-item-sub {display: flex;flex-wrap: wrap; gap: 10px;font-size: 0.85rem;color: var(--text-secondary);margin-top: 5px;}
        .modal-fullscreen-content {width: 90%;max-width: 1000px;height: auto;max-height: 90vh;display: flex;flex-direction: column;padding: 0;}
        .modal-header {display: flex;justify-content: space-between;align-items: center;padding: 20px 25px;border-bottom: 1px solid var(--border-color);}
        .modal-body {display: flex;flex-direction: row;gap: 30px;padding: 25px;flex-grow: 1;overflow-y: auto;}
        .form-column {flex: 1;display: flex;flex-direction: column;gap: 15px;}
        .modal-footer {display: flex;justify-content: flex-end;padding: 20px 25px;border-top: 1px solid var(--border-color);}
        @media (max-width: 768px) {.modal-body {flex-direction: column;}}
    </style>
</head>
<body>
    <div id="app">
    
        <div v-if="currentPage === 'timeClockKiosk'" class="container">
            <div class="time-clock-kiosk">
                <h1>Panel Czasu Pracy</h1>
                <p style="color:var(--text-secondary)">Wybierz siebie z listy, aby rozpocząć lub zakończyć pracę</p>
                <div class="employee-list-vertical">
                    <div v-for="employee in sortedEmployees" :key="employee.id" class="employee-tile" @click="selectEmployeeForClock(employee)">
                        <svg class="employee-tile-icon" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>
                        <span>{{ employee.name }}</span>
                    </div>
                </div>
            </div>
            <div v-if="isClockActionModalOpen" class="modal" @click.self="isClockActionModalOpen = false">
                <div class="panel clock-modal-content">
                     <h2 style="margin-top: 0;">Witaj, {{ selectedEmployeeForClock.name }}</h2>
                     <div v-if="!isEmployeeWorking">
                        <button class="button button-success" @click="startWork(selectedEmployeeForClock.id)">Rozpocznij pracę</button>
                    </div>
                    <div v-else>
                        <button class="button button-danger" @click="stopWork(selectedEmployeeForClock.id)">Zakończ pracę</button>
                    </div>
                </div>
            </div>
        </div>

        <div v-else>
            <div v-if="!currentUser" class="login-view">
                <div class="panel" style="text-align: center; width: 90%; max-width: 400px;">
                    <img style="width:120px;height:120px;border-radius:50%;margin-bottom:30px;" src="https://i.imgur.com/dXRrPyB.jpeg" alt="Logo">
                    <input class="input" type="text" v-model="loginInput" placeholder="Wpisz login..." @keyup.enter="login">
                    <button class="button" @click="login" style="margin-top:20px;">Zaloguj się</button>
                </div>
            </div>

            <div v-else class="container">
                <div v-if="currentPage === 'categories'">
                     <div class="header">
                        <h1>Kategorie</h1>
                        <div>
                            <button v-if="isAdmin" class="icon-button" @click="currentPage = 'admin'" title="Panel Admina">
                                <svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.438.995s.145.755.438.995l1.003.827c.48.398.668 1.03.26 1.431l-1.296 2.247a1.125 1.125 0 0 1-1.37.49l-1.217-.456c-.355-.133-.75-.072-1.075.124a6.37 6.37 0 0 1-.22.127c-.331.183-.581.495-.645.87l-.213 1.281c-.09.543-.56.94-1.11.94h-2.593c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.645-.87a6.37 6.37 0 0 1-.22-.127c-.324-.196-.72-.257-1.075-.124l-1.217.456a1.125 1.125 0 0 1-1.37-.49l-1.296-2.247a1.125 1.125 0 0 1 .26-1.431l1.003-.827c.293-.24.438.613-.438-.995s-.145-.755-.438-.995l-1.003-.827a1.125 1.125 0 0 1-.26-1.431l1.296-2.247a1.125 1.125 0 0 1 1.37-.49l1.217.456c.355.133.75.072 1.075-.124.073-.044.146-.087.22-.127.331-.183.581-.495.645-.87l.213-1.281ZM15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>
                            </button>
                            <button class="icon-button" @click="logout" title="Wyloguj">
                                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m-3-3-3-3m0 0 3-3m-3 3h12" /></svg>
                            </button>
                        </div>
                    </div>
                    <div class="category-grid">
                        <div class="panel category-card" v-for="cat in categories" :key="cat.id" @click="selectCategory(cat.id)">
                            <span>{{ cat.name }}</span>
                        </div>
                    </div>
                </div>

                <div v-if="currentPage === 'swipe'" class="swipe-view">
                    <div class="header">
                        <h1>{{ selectedCategory.name }}</h1>
                        <button class="icon-button" @click="currentPage = 'categories'">
                            <svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg>
                        </button>
                    </div>
                    <div class="swipe-area">
                        <p v-if="!currentProduct">Brak produktów w tej kategorii.</p>
                        <div v-if="currentProduct" class="swipe-card" :key="productIndex" @mousedown="swipeStart" @mousemove="swipeMove" @mouseup="swipeEnd" @mouseleave="swipeEnd" @touchstart="swipeStart" @touchmove="swipeMove" @touchend="swipeEnd" :style="{ transform: cardTransform }">
                            <div class="panel swipe-card-inner">
                                <img class="product-image" :src="currentProduct.imageUrl" alt="Produkt">
                                <h2 class="product-name">{{ currentProduct.name }}</h2>
                                <p style="color:var(--text-secondary)">Zapotrzebowanie: {{ currentProduct.demand }} {{ currentProduct.unit }}</p>
                                <div style="margin-top: auto;">
                                    <label style="font-size: 0.9rem;">Stan na magazynie:</label>
                                    <input class="input" type="number" v-model.number="currentStock" placeholder="0">
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="button" @click="currentPage = 'summary'" :disabled="isOrderBlocked">Podsumowanie ({{ shoppingCart.length }})</button>
                    <p v-if="isOrderBlocked" style="text-align:center;color:var(--danger);margin-top:10px;">Dziś jest święto - nie można składać zamówień.</p>
                </div>

                <div v-if="currentPage === 'summary'">
                    <div class="header"><h1>Podsumowanie</h1><button class="icon-button" @click="currentPage = 'swipe'"><svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg></button></div>
                    <div v-if="shoppingCart.length === 0" class="panel">Koszyk jest pusty.</div>
                    <div v-else>
                        <div v-for="(group, categoryName) in cartGroupedByCategory" :key="categoryName" class="panel cart-item-group">
                            <h3>{{ categoryName }}</h3>
                            <div v-for="(item, index) in group.items" :key="index" class="cart-item-details">
                                <div class="cart-item-main">
                                    <strong>{{ item.name }}</strong>
                                    <span>{{ item.orderAmount }} {{ item.unit }}</span>
                                    <strong style="margin-left: auto;">{{ item.orderPrice.toFixed(2) }} zł</strong>
                                </div>
                                <div class="cart-item-sub">
                                    <span>Cena: {{ item.pricePerUnit.toFixed(2) }} zł / {{ item.unit }}</span>
                                    <span>|</span>
                                    <span>Dostawca: {{ item.supplier }}</span>
                                    <span v-if="item.altSupplier">|</span>
                                    <span v-if="item.altSupplier">Dost. alt: {{ item.altSupplier }}</span>
                                </div>
                            </div>
                            <p style="text-align:right;font-weight:bold;margin-top:10px;border-top:1px solid var(--border-color);padding-top:10px;">Suma: {{ group.total.toFixed(2) }} zł</p>
                        </div>
                        <div class="panel" style="text-align:right;font-size:1.5rem;font-weight:bold;">Całkowita suma: {{ cartTotal.toFixed(2) }} zł</div>
                        <button class="button" @click="placeOrder" style="margin-top:20px;">Złóż zamówienie</button>
                    </div>
                </div>

                <div v-if="currentPage === 'admin'">
                    <div class="header">
                        <h1>Panel Administratora</h1>
                        <button class="icon-button" @click="currentPage = 'categories'">
                             <svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" /></svg>
                        </button>
                    </div>
                    
                    <div class="admin-nav">
                        <button class="button" :class="{active: adminSubPage === 'orders'}" @click="adminSubPage = 'orders'">Zamówienia</button>
                        <button class="button" :class="{active: adminSubPage === 'products'}" @click="adminSubPage = 'products'">Produkty</button>
                        <button class="button" :class="{active: adminSubPage === 'employees' || adminSubPage === 'editEmployee'}" @click="adminSubPage = 'employees'">Pracownicy</button>
                        <button class="button button-danger" @click="openTimeClockKiosk">Uruchom Panel Czasu</button>
                    </div>

                    <div v-if="adminSubPage === 'orders'">
                        <h2>Zapisane Zamówienia</h2>
                        <div v-if="orders.length === 0" class="panel">Brak zamówień.</div>
                        <div v-else v-for="order in orders" :key="order.id" class="panel" style="margin-top:15px;">
                            <p><strong>Zamówienie #{{order.id}}</strong> z {{new Date(order.date).toLocaleString('pl-PL')}} przez <strong>{{order.user.name}}</strong></p>
                            <div v-for="item in order.items" :key="item.id" class="cart-item-details" style="padding-left: 20px;">
                                <div class="cart-item-main">
                                    <strong>{{ item.name }}</strong>
                                    <span>{{ item.orderAmount }} {{ item.unit }}</span>
                                </div>
                                <div class="cart-item-sub">
                                    <span>Dostawca: {{ item.supplier }}</span>
                                    <span v-if="item.altSupplier">|</span>
                                    <span v-if="item.altSupplier">Dost. alt: {{ item.altSupplier }}</span>
                                    <span>|</span>
                                    <span>Godzina zam.: {{ item.orderTime }}</span>
                                </div>
                            </div>
                            <p style="text-align:right;font-weight:bold;">Suma: {{order.totalPrice.toFixed(2)}} zł</p>
                        </div>
                    </div>

                    <div v-if="adminSubPage === 'products'">
                        <button class="button" @click="isAddProductModalOpen = true" style="margin-bottom: 20px;">+ Dodaj Nowy Produkt</button>
                    </div>

                    <div v-if="adminSubPage === 'employees'">
                        <button class="button" @click="isAddEmployeeModalOpen = true" style="margin-bottom: 20px;">+ Dodaj Pracownika</button>
                        <div class="panel">
                            <h2>Lista Pracowników</h2>
                            <div v-for="employee in sortedEmployees" :key="employee.id" class="employee-list-item" @click="editEmployee(employee)">
                                <div class="status-dot" :class="activeSessions.includes(employee.login) ? 'online' : 'offline'"></div>
                                <div style="flex-grow: 1;">
                                    <strong>{{ employee.name }}</strong>
                                    <div style="font-size: 0.9em; color: var(--text-secondary);">{{ employee.role }}</div>
                                </div>
                                <span>{{ employee.hourlyRate }} zł/h</span>
                            </div>
                        </div>
                    </div>
                    
                    <div v-if="adminSubPage === 'editEmployee' && editingEmployee">
                         <div class="panel">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color)">
                                <h2>Edytujesz: {{ editingEmployee.name }}</h2>
                                <button class="button" @click="adminSubPage = 'employees'" style="width: auto; padding: 10px 20px;">&larr; Wróć do listy</button>
                            </div>
                            <div class="employee-info-grid">
                                <div class="form-group"><label>Imię i Nazwisko</label><input class="input" v-model="editingEmployee.name"></div>
                                <div class="form-group"><label>Login</label><input class="input" v-model="editingEmployee.login"></div>
                                <div class="form-group"><label>Stawka Godzinowa</label><input type="number" class="input" v-model.number="editingEmployee.hourlyRate"></div>
                                <div class="form-group"><label>Stanowisko</label>
                                    <select class="input" v-model="editingEmployee.role">
                                        <option v-for="role in roles" :key="role" :value="role">{{ role }}</option>
                                    </select>
                                </div>
                            </div>
                            <button class="button" @click="updateEmployee" style="margin-top:20px;">Zapisz Zmiany</button>
                            <div style="margin-top:30px; border-top: 1px solid var(--border-color); padding-top:20px;">
                                <h3>Statystyki Pracy</h3>
                                <p><strong>Łączny czas pracy:</strong> {{ employeeStats.formattedTime }}</p>
                                <p><strong>Szacunkowe zarobki:</strong> {{ employeeStats.totalEarnings.toFixed(2) }} zł</p>
                                <button class="button button-danger" @click="promptResetHours" style="margin-top: 15px; width: auto; padding: 10px 20px; float: right;">Zresetuj Godziny</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div v-if="isAddProductModalOpen" class="modal" @click.self="isAddProductModalOpen = false">
            <div class="panel modal-fullscreen-content">
                <div class="modal-header">
                    <h2 style="margin: 0;">Dodaj Nowy Produkt</h2>
                    <button class="icon-button" @click="isAddProductModalOpen = false"><svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg></button>
                </div>
                <div class="modal-body">
                    <div class="form-column">
                        <div class="form-group"><label>Nazwa</label><input class="input" v-model="newProduct.name"></div>
                        <div class="form-group"><label>Kategoria</label>
                            <select class="input" v-model="newProduct.category"><option disabled value="">Wybierz...</option><option v-for="cat in categories" :value="cat.id">{{cat.name}}</option></select>
                        </div>
                        <div class="form-group"><label>URL Zdjęcia</label><input class="input" v-model="newProduct.imageUrl"></div>
                        <div class="form-group"><label>Jednostka</label><input class="input" v-model="newProduct.unit"></div>
                        <div class="form-group"><label>Cena za jedn.</label><input class="input" type="number" v-model.number="newProduct.pricePerUnit"></div>
                    </div>
                    <div class="form-column">
                        <div class="form-group"><label>Zapotrzebowanie tyg.</label><input class="input" type="number" v-model.number="newProduct.demand"></div>
                        <div class="form-group"><label>Wielkość paczki</label><input class="input" type="number" v-model.number="newProduct.packageSize"></div>
                        <div class="form-group"><label>Dostawca</label><input class="input" v-model="newProduct.supplier"></div>
                        <div class="form-group"><label>Dostawca altern.</label><input class="input" v-model="newProduct.altSupplier"></div>
                        <div class="form-group"><label>Godzina zamówienia</label><input class="input" type="time" v-model="newProduct.orderTime"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="button" @click="isAddProductModalOpen = false" style="background: var(--text-secondary); margin-right: 15px;">Anuluj</button>
                    <button class="button" @click="addProduct">Dodaj Produkt</button>
                </div>
            </div>
        </div>
        <div v-if="isAddEmployeeModalOpen" class="modal" @click.self="isAddEmployeeModalOpen = false">
            <div class="panel modal-fullscreen-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2 style="margin: 0;">Dodaj Nowego Pracownika</h2>
                    <button class="icon-button" @click="isAddEmployeeModalOpen = false"><svg class="icon-svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg></button>
                </div>
                <div class="modal-body">
                    <div class="form-column">
                        <div class="form-group"><label>Imię i Nazwisko</label><input class="input" v-model="newEmployee.name"></div>
                        <div class="form-group"><label>Login</label><input class="input" v-model="newEmployee.login" placeholder="np. natalia33201"></div>
                    </div>
                    <div class="form-column">
                        <div class="form-group"><label>Stawka Godzinowa (zł)</label><input type="number" class="input" v-model.number="newEmployee.hourlyRate"></div>
                        <div class="form-group"><label>Stanowisko</label>
                            <select class="input" v-model="newEmployee.role">
                                <option disabled value="">Wybierz stanowisko...</option>
                                <option v-for="role in roles" :key="role" :value="role">{{ role }}</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="button" @click="addEmployee">Dodaj Pracownika</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        const ROLES_HIERARCHY = ["Właściciel", "Menager", "Szef Kuchni", "Kucharz", "Pomoc Kuchenna", "Kelner", "Praktykant"];

        createApp({
            data() {
                return {
                    currentPage: '', 
                    adminSubPage: 'employees',
                    currentUser: null, 
                    loginInput: '',
                    users: [], products: [], categories: [], orders: [], holidays: [], shoppingCart: [],
                    workSessions: [], activeSessions: [],
                    selectedEmployeeForClock: null, isClockActionModalOpen: false,
                    isAddProductModalOpen: false, isAddEmployeeModalOpen: false,
                    editingEmployee: null,
                    newProduct: { name: '', imageUrl: '', category: '', pricePerUnit: 0, unit: 'kg', demand: 0, packageSize: 1, orderTime: '12:00', supplier: '', altSupplier: '' },
                    newEmployee: { name: '', login: '', role: '', hourlyRate: 0 },
                    roles: ROLES_HIERARCHY,
                    selectedCategory: null, productIndex: 0, currentStock: null, cardTransform: '', swipeStartX: 0, isSwiping: false,
                }
            },
            computed: {
                isAdmin() { return this.currentUser?.role === 'Właściciel' || this.currentUser?.role === 'Menager'; },
                sortedEmployees() { return [...this.users].sort((a, b) => ROLES_HIERARCHY.indexOf(a.role) - ROLES_HIERARCHY.indexOf(b.role)); },
                isEmployeeWorking() { if (!this.selectedEmployeeForClock) return false; return this.workSessions.some(s => s.userId === this.selectedEmployeeForClock.id && !s.endTime);},
                employeeStats() {
                    if (!this.editingEmployee) return { totalHours: 0, totalEarnings: 0, formattedTime: '0h 0min' };
                    const employeeSessions = this.workSessions.filter(s => s.userId === this.editingEmployee.id && s.endTime);
                    const totalHoursDecimal = employeeSessions.reduce((sum, s) => sum + (s.totalHours || 0), 0);
                    const totalEarnings = totalHoursDecimal * this.editingEmployee.hourlyRate;
                    const totalMinutes = Math.round(totalHoursDecimal * 60);
                    const hours = Math.floor(totalMinutes / 60);
                    const minutes = totalMinutes % 60;
                    const formattedTime = `${hours}h ${minutes}min`;
                    return { totalHours: totalHoursDecimal, totalEarnings, formattedTime };
                },
                productsToSwipe() { return this.selectedCategory ? this.products.filter(p => p.category === this.selectedCategory.id) : []; },
                currentProduct() { return this.productsToSwipe[this.productIndex] || null; },
                cartTotal() { return this.shoppingCart.reduce((total, item) => total + item.orderPrice, 0); },
                cartGroupedByCategory() {
                    return this.shoppingCart.reduce((acc, item) => {
                        const category = this.categories.find(c => c.id === item.category)?.name || 'Inne';
                        if (!acc[category]) acc[category] = { items: [], total: 0 };
                        acc[category].items.push(item);
                        acc[category].total += item.orderPrice;
                        return acc;
                    }, {});
                },
                isOrderBlocked() { const today = new Date().toISOString().split('T')[0]; return this.holidays.includes(today); }
            },
            methods: {
                async initData() {
                    try {
                        const response = await fetch('/api/data');
                        const data = await response.json();
                        this.users = data.users;
                        this.workSessions = data.workSessions;
                        this.products = data.products;
                        this.categories = data.categories;
                        this.orders = data.orders.sort((a, b) => new Date(b.date) - new Date(a.date));
                        this.holidays = data.holidays;
                        this.activeSessions = data.activeSessions;
                    } catch (e) { alert("Błąd połączenia z serwerem. Upewnij się, że 'node server.js' jest uruchomiony."); }
                },
                async login() {
                    try {
                        const response = await fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ login: this.loginInput }) });
                        if (!response.ok) throw new Error('Błędny login');
                        this.currentUser = await response.json();
                        localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                        await this.initData();
                        this.currentPage = 'categories'; 
                    } catch (e) { alert(e.message); }
                },
                async logout() {
                    try {
                        if (this.currentUser) { await fetch('/api/logout', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ login: this.currentUser.login }) }); }
                    } finally {
                        localStorage.removeItem('currentUser');
                        this.currentUser = null;
                        this.loginInput = '';
                        this.currentPage = '';
                    }
                },
                openTimeClockKiosk() {
                    if (this.currentUser) { fetch('/api/logout', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ login: this.currentUser.login }) }); }
                    localStorage.removeItem('currentUser');
                    this.currentUser = null; 
                    this.currentPage = 'timeClockKiosk';
                    this.initData();
                },
                selectEmployeeForClock(employee) { this.selectedEmployeeForClock = employee; this.isClockActionModalOpen = true; },
                async startWork(userId){
                    const response = await fetch('/api/work/start', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId }) });
                    const result = await response.json();
                    alert(result.message);
                    if(response.ok){ 
                        this.workSessions.push(result.session); 
                        this.isClockActionModalOpen = false; 
                        this.selectedEmployeeForClock = null;
                    }
                },
                async stopWork(userId){
                    const activeSession = this.workSessions.find(s => s.userId === userId && !s.endTime);
                    if(!activeSession) return alert("Ten pracownik nie ma aktywnej sesji pracy.");
                    const response = await fetch('/api/work/stop', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId, sessionId: activeSession.id }) });
                    const result = await response.json();
                    alert(result.message);
                    if(response.ok){ 
                        await this.initData(); 
                        this.isClockActionModalOpen = false; 
                        this.selectedEmployeeForClock = null;
                    }
                },
                editEmployee(employee) { this.editingEmployee = { ...employee }; this.adminSubPage = 'editEmployee'; },
                async updateEmployee() {
                    const response = await fetch(`/api/users/${this.editingEmployee.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(this.editingEmployee) });
                    const result = await response.json();
                    alert(result.message);
                    if (response.ok) { await this.initData(); this.adminSubPage = 'employees'; }
                },
                promptResetHours() {
                    const enteredLogin = prompt('Aby zresetować godziny i zarobki tego pracownika, wpisz swój login administratora i wciśnij OK.');
                    if (enteredLogin === null) return;
                    if (enteredLogin === this.currentUser.login) { this.executeResetHours(); } 
                    else { alert('Błędny login. Operacja anulowana.'); }
                },
                async executeResetHours() {
                    if(!this.editingEmployee) return;
                    const response = await fetch(`/api/work/user/${this.editingEmployee.id}`, { method: 'DELETE' });
                    const result = await response.json();
                    alert(result.message);
                    if (response.ok) {
                        await this.initData();
                        const updatedUser = this.users.find(u => u.id === this.editingEmployee.id);
                        if(updatedUser) this.editingEmployee = { ...updatedUser };
                    }
                },
                selectCategory(catId) { this.selectedCategory = this.categories.find(c => c.id === catId); this.productIndex = 0; this.currentPage = 'swipe'; },
                swipeStart(e) { this.isSwiping = true; this.swipeStartX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX; },
                swipeMove(e) { if (!this.isSwiping) return; const currentX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX; const deltaX = currentX - this.swipeStartX; this.cardTransform = `translateX(${deltaX}px) rotate(${deltaX / 20}deg)`; },
                swipeEnd(e) { if (!this.isSwiping) return; this.isSwiping = false; const currentX = e.type.includes('mouse') ? e.clientX : e.changedTouches[0].clientX; const deltaX = currentX - this.swipeStartX; if (deltaX < -100) this.addToCart(); else if (deltaX > 100) this.nextProduct(); else this.cardTransform = ''; },
                addToCart() {
                    const product = this.currentProduct;
                    const stock = this.currentStock || 0;
                    const needed = product.demand - stock;
                    if (needed <= 0) { alert(`${product.name}: Wystarczający zapas na magazynie.`); return this.nextProduct(); }
                    const packagesToOrder = Math.ceil(needed / product.packageSize);
                    const amountToOrder = packagesToOrder * product.packageSize;
                    this.shoppingCart.push({ ...product, orderAmount: amountToOrder, orderPrice: amountToOrder * product.pricePerUnit });
                    this.nextProduct();
                },
                nextProduct() { this.productIndex++; this.currentStock = null; this.cardTransform = ''; },
                async addProduct() {
                    const response = await fetch('/api/products', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(this.newProduct) });
                    const result = await response.json();
                    alert(result.message);
                    if (response.ok) { this.products = result.products; this.newProduct = { name: '', imageUrl: '', category: '', pricePerUnit: 0, unit: 'kg', demand: 0, packageSize: 1, orderTime: '12:00', supplier: '', altSupplier: '' }; this.isAddProductModalOpen = false; }
                },
                async addEmployee() {
                    if(!this.newEmployee.name || !this.newEmployee.login || !this.newEmployee.role){ return alert("Wypełnij wszystkie pola!"); }
                    const response = await fetch('/api/users', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(this.newEmployee) });
                    const result = await response.json();
                    alert(result.message);
                    if (response.ok) { this.users = result.users; this.newEmployee = { name: '', login: '', role: '', hourlyRate: 0 }; this.isAddEmployeeModalOpen = false; }
                },
                 async placeOrder() {
                    if (this.isOrderBlocked) return alert("Nie można składać zamówień w święta.");
                    const response = await fetch('/api/orders', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user: this.currentUser, items: this.shoppingCart, totalPrice: this.cartTotal }) });
                     const result = await response.json();
                     alert(result.message);
                     if(response.ok) { 
                         this.shoppingCart = []; 
                         this.currentPage = 'categories'; 
                         this.initData(); 
                    }
                 }
            },
            created() {
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    this.currentUser = JSON.parse(savedUser);
                    this.currentPage = 'categories';
                }
                this.initData();
            }
        }).mount('#app');
    </script>
</body>
</html>
