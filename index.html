<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milkshake App - System</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ... wszystkie style bez zmian ... */
        .schedule-group { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; background: rgba(0,0,0,0.1); padding: 10px; border-radius: 8px; }
        .schedule-group label { display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: rgba(255,255,255,0.05); border-radius: 6px; cursor: pointer; }
        .schedule-group input { width: auto; }
        .file-input-label { display: block; text-align: center; padding: 15px; border: 2px dashed var(--border-color); border-radius: 12px; cursor: pointer; transition: all .2s; }
        .file-input-label:hover { border-color: var(--accent); background: rgba(106, 17, 203, 0.1); }
        .file-input-label span { color: var(--text-secondary); }
        .product-group { margin-bottom: 25px; }
        .product-group h3 { padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .product-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 8px; }
    </style>
</head>
<body>
    <div id="app">
        <div v-if="isAddProductModalOpen" class="modal" @click.self="isAddProductModalOpen = false">
            <div class="panel modal-fullscreen-content">
                <div class="modal-header">
                    <h2 style="margin: 0;">Dodaj Nowy Produkt</h2>
                    <button class="icon-button" @click="isAddProductModalOpen = false">...</svg></button>
                </div>
                <div class="modal-body">
                    <div class="form-column">
                        <div class="form-group"><label>Nazwa Produktu</label><input class="input" v-model="newProduct.name"></div>
                        <div class="form-group"><label>Zdjęcie Produktu</label>
                            <label class="file-input-label">
                                <input type="file" @change="handleImageUpload" accept="image/*" style="display: none;">
                                <span v-if="!newProduct.imageFile">Kliknij, aby wybrać plik</span>
                                <span v-else style="color: var(--success);">Wybrano: {{ newProduct.imageFile.name }}</span>
                            </label>
                        </div>
                        <div class="form-group"><label>Kategoria</label>
                            <select class="input" v-model="newProduct.category">...</select>
                        </div>
                        <div class="form-group"><label>Dostawca</label><input class="input" v-model="newProduct.supplier"></div>
                        <div class="form-group"><label>Dostawca alternatywny</label><input class="input" v-model="newProduct.altSupplier"></div>
                    </div>
                    <div class="form-column">
                        <div class="form-group"><label>Zapotrzebowanie dzienne</label><input class="input" type="number" v-model.number="newProduct.demand"></div>
                        <div class="form-group"><label>Jednostka</label>
                            <select class="input" v-model="newProduct.unit">
                                <option value="kg">Kg - Kilogram</option>
                                <option value="l">L - Litr</option>
                                <option value="szt">Szt - Sztuka</option>
                                <option value="kr">Kr - Karton</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Wielkość paczki</label><input class="input" type="number" v-model.number="newProduct.packageSize"></div>
                        <div class="form-group"><label>Cena za jedn.</label><input class="input" type="number" v-model.number="newProduct.pricePerUnit"></div>
                        <div class="form-group"><label>Godzina zamówienia</label><input class="input" type="time" v-model="newProduct.orderTime"></div>
                    </div>
                </div>
                <div class="form-group" style="padding: 0 25px;">
                    <label style="text-align: center; margin-bottom: 10px;">Harmonogram Zamówień (dni tygodnia)</label>
                    <div class="schedule-group">
                        <label v-for="day in daysOfWeek" :key="day"><input type="checkbox" :value="day" v-model="newProduct.scheduleDays"> {{ day }}</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="button" @click="addProduct">Dodaj Produkt</button>
                </div>
            </div>
        </div>

        <div v-if="adminSubPage === 'products'">
            <button class="button" @click="isAddProductModalOpen = true" style="margin-bottom: 20px;">+ Dodaj Nowy Produkt</button>
            <div class="panel">
                <h2>Wszystkie Produkty</h2>
                <div v-if="Object.keys(productsGroupedBySupplier).length === 0">Brak dodanych produktów.</div>
                <div v-for="(products, supplier) in productsGroupedBySupplier" :key="supplier" class="product-group">
                    <h3>{{ supplier }}</h3>
                    <div v-for="product in products" :key="product._id" class="product-list-item">
                        <span>{{ product.name }}</span>
                        <span style="color: var(--text-secondary);">{{ product.demand }} {{ product.unit }} / dzień</span>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="adminSubPage === 'orders'">
            <h2>Zapisane Zamówienia</h2>
            <div v-if="orders.length === 0" class="panel">Brak zamówień.</div>
            <div v-else v-for="order in orders" :key="order._id" class="panel" style="margin-top:15px;">
                <div v-for="item in order.items" :key="item._id" class="cart-item-details" style="padding-left: 20px;">
                    <div class="cart-item-sub">
                        <span>Dostawca: {{ item.supplier }}</span>
                        <span v-if="item.scheduleDays && item.scheduleDays.length">| Harmonogram: {{ item.scheduleDays.join(', ') }}</span>
                    </div>
                </div>
                </div>
        </div>
        
    </div>

    <script>
        createApp({
            data() {
                return {
                    // ... reszta danych
                    newProduct: { 
                        name: '', category: '', pricePerUnit: 0, unit: 'kg', 
                        demand: 0, packageSize: 1, orderTime: '12:00', 
                        supplier: '', altSupplier: '', imageFile: null, scheduleDays: [] 
                    },
                    daysOfWeek: ['Pon', 'Wt', 'Śr', 'Czw', 'Pt', 'Sob', 'Ndz'],
                }
            },
            computed: {
                productsGroupedBySupplier() {
                    const groups = this.products.reduce((acc, product) => {
                        const supplier = product.supplier || 'Brak dostawcy';
                        if (!acc[supplier]) {
                            acc[supplier] = [];
                        }
                        acc[supplier].push(product);
                        return acc;
                    }, {});
                    
                    // Sortowanie dostawców alfabetycznie
                    return Object.keys(groups).sort().reduce((sorted, key) => {
                        sorted[key] = groups[key];
                        return sorted;
                    }, {});
                },
                // ... reszta computed
            },
            methods: {
                handleImageUpload(event) {
                    this.newProduct.imageFile = event.target.files[0];
                },
                async addProduct() {
                    const formData = new FormData();
                    Object.keys(this.newProduct).forEach(key => {
                        if (key === 'imageFile') {
                            if (this.newProduct.imageFile) {
                                formData.append('image', this.newProduct.imageFile);
                            }
                        } else if (key === 'scheduleDays') {
                            formData.append(key, JSON.stringify(this.newProduct[key]));
                        } else {
                            formData.append(key, this.newProduct[key]);
                        }
                    });

                    const response = await fetch('/api/products', { method: 'POST', body: formData });
                    const result = await response.json();
                    alert(result.message);
                    if (response.ok) {
                        this.products = result.products;
                        // resetuj formularz
                        this.newProduct = { name: '', category: '', pricePerUnit: 0, unit: 'kg', demand: 0, packageSize: 1, orderTime: '12:00', supplier: '', altSupplier: '', imageFile: null, scheduleDays: [] };
                        this.isAddProductModalOpen = false;
                    }
                },
                // ... reszta metod
            }
        }).mount('#app');
    </script>
</body>
</html>
